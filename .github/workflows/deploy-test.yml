name: ğŸš€ YELL:O Deploy for staging server

on:
  push:
    branches: [ "staging" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: ğŸ‘‰ JDK 17 zulu ë²„ì „ì„ ì„¸íŒ…í•©ë‹ˆë‹¤.
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'
          cache: gradle

      - name: ğŸ˜ Gradleì— ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
        run: chmod +x gradlew
        shell: bash

      ## ì‹œí¬ë¦¿ í‚¤ ì„¤ì •
      - name: ğŸ” application.yml ë“± í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¸íŒ…í•©ë‹ˆë‹¤.
        run: |
          cd ./src/main/resources
          touch ./application.yml
          echo "$APPLICATION" > ./application.yml
          touch ./firebase_key.json
          echo "$FIREBASE_JSON" > ./firebase_key.json
          sed -i 's/#/"/g' ./firebase_key.json
          touch ./google_client_secret.json
          echo "$GOOGLE_CLIENT_SECRET" > ./google_client_secret.json
          sed -i 's/#/"/g' ./google_client_secret.json
          touch ./apple_client_secret.json
          echo "$APPLE_CLIENT_SECRET" > ./apple_client_secret.json
          sed -i 's/#/"/g' ./apple_client_secret.json
        env:
          APPLICATION: ${{ secrets.APPLICATION_TEST }}
          FIREBASE_JSON: ${{ secrets.FIREBASE_JSON }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          APPLE_CLIENT_SECRET: ${{ secrets.APPLE_CLIENT_SECRET }}
        shell: bash

      - name: ğŸ˜ Gradleë¡œ ë¹Œë“œ ì‹¤í–‰
        run: ./gradlew build

      - name: ğŸ“¦ ë°°í¬ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•œ .zip íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
        run: |
          mkdir deploy
          cp ./docker/docker-compose.blue.yml ./deploy/
          cp ./docker/docker-compose.green.yml ./deploy/
          cp ./appspec.yml ./deploy/
          cp ./docker/Dockerfile ./deploy/
          cp ./scripts/*.sh ./deploy/
          cp ./build/libs/*.jar ./deploy/
          zip -r -qq -j ./yello-build.zip ./deploy
        shell: bash

      - name: â³ AWSì— ì—°ê²°ì„ ì§„í–‰í•©ë‹ˆë‹¤.
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_TEST_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_TEST_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸª£ ë°°í¬ë¥¼ ìœ„í•´ S3ì— í”„ë¡œì íŠ¸ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
        run: |
          aws s3 cp \
          --region ap-northeast-2 \
          ./yello-build.zip s3://yello-test-bucket

      - name: ğŸ“¡ CodeDeployì— ë°°í¬ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
        run: aws deploy create-deployment --application-name yello-test-deploy
          --deployment-config-name CodeDeployDefault.OneAtATime
          --deployment-group-name yello-test-deploy
          --s3-location bucket=yello-test-bucket,bundleType=zip,key=yello-build.zip

      - name: ğŸ’¡ ë°°í¬ ìƒíƒœë¥¼ Slackì„ í†µí•´ ì „ì†¡í•©ë‹ˆë‹¤.
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: general
          SLACK_COLOR: ${{ job.status }}
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_MESSAGE: ê°œë°œ ì„œë²„ ë°°í¬ì— ${{ job.status }} í–ˆìŠµë‹ˆë‹¤.
          SLACK_TITLE: ğŸš€ YELL:O ê°œë°œ ì„œë²„ ë°°í¬ ê²°ê³¼ ğŸš€
          SLACK_USERNAME: Notification-Bot
          SLACK_WEBHOOK: ${{ secrets.SLACK_URL }}
        if: always()
